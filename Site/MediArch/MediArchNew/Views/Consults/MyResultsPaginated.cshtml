@model IEnumerable<Data.Domain.Entities.Consult>

@using MediArch.Services.Interfaces
@inject IApplicationUserService user_service

@using Data.Domain.Interfaces.ServiceInterfaces
@inject IConsultService consult_service

@using Data.Domain.Interfaces.ServiceInterfaces
@inject IMedicineService medicine_service

@{
    ViewData["Title"] = "My Results";
}

<br />
<img src="~/images//Heart.png" class="img_logos img_heart">
<br />

<div class="talbe_remake">
    <br />
    <table class="table">
        <thead>
            <tr>
                <th>
                    Medic
                </th>
                <th>
                    Consult's Date
                </th>
                <th>
                    Result
                </th>
                <th>
                    Prescription
                </th>
                <th>
                    Files
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        @if (user_service.ApplicationUserExists(@item.MedicId.ToString()))
                        {
                            <a asp-action="Details" asp-controller="Account" asp-route-id="@item.MedicId"><b><img src="@user_service.GetProfilePictureLink(item.MedicId.ToString())" class="navbar_img"> @user_service.GetFullNameById(item.MedicId.ToString())</b></a>
                        }
                        else
                        {
                        <b>Doctor not fount.</b>
                        }
                    </td>
                    <td>
                        <div class="btn-group dropright">
                            <a class="btn btn-secondary dropdown-toggle dropdown-toggle-split flt_right" data-toggle="dropdown">@Html.DisplayFor(modelItem => item.ConsultDate) </a>
                            <ul class="dropdown-menu special_dropright">
                                <li><a asp-action="Details" asp-route-id="@item.Id">Details</a></li>
                            </ul>
                        </div>
                    </td>
                    <td>
                        @foreach (var line in @item.ConsultResult.CollapseAnswerText().Split("\n"))
                        { @line<br />}
                    </td>
                    <td>
                        @if (@item.Medicines.Split(",").Count() > 1)
                        {
                            @foreach (var med in @item.Medicines.Split(","))
                            {
                                var medicine = medicine_service.GetMedicineByName(med.Split("(")[0]);
                                if (medicine != null)
                                {
                                    <a asp-action="Details" asp-controller="Medicines" asp-route-id="@medicine.Id" class="size_16">@med</a><br />
                                }
                                else
                                {
                                    @med<br />
                                }
                            }
                        }
                        else
                        {
                            @foreach (var med in @item.Medicines.Split("\n"))
                            {
                                var medicine = medicine_service.GetMedicineByName(med.Split("(")[0]);
                                if (medicine != null)
                                {
                                    <a asp-action="Details" asp-controller="Medicines" asp-route-id="@medicine.Id" class="size_16">@med</a><br />
                                }
                                else
                                {
                                    @med<br />
                                }
                            }
                        }
                    </td>
                    <td>
                        @foreach (var file in consult_service.GetNamesOfFiles(item.Id))
                        {
                            using (Html.BeginForm("Download", "Consults", new { consultId = item.Id, fileName = @file }, FormMethod.Post, null, new { }))
                            {
                                <button class="button_download">@file</button>
                            }
                            }
                        </td>
                    </tr>
            }
        </tbody>
    </table>
</div>
    <input type="hidden" id="CurrentIdPage" value="1" />
    @{
        string UsId_str = (string)ViewData["Id"];
        Guid UsId = new Guid(UsId_str);
    }
    @if (consult_service.GetNumberOfPagesForMyResultsById(UsId) > 1)
    {
        <center>
            <input type="button" id="No_Page_<<" value="<<" class="Pagination_Button"/>
            <input type="button" id="No_Page_<" value="<" class="Pagination_Button"/>
            <b id="...1" class="Pagination_Button">...</b>
            @for (int NrOfPage = 1; NrOfPage <= @consult_service.GetNumberOfPagesForMyResultsById(UsId); NrOfPage++)
            {
                <input type="button" id="No_Page_@NrOfPage" value="@NrOfPage" class="Pagination_Button"/>
            }
            <b id="...2" class="Pagination_Button">...</b>
            <input type="button" id="No_Page_>" value=">" class="Pagination_Button"/>
            <input type="button" id="No_Page_>>" value=">>" class="Pagination_Button"/>
        </center>
    }


        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script type="text/javascript">

        $(document).ready(function () {

            var currentlink = window.location.href;
            var currentLinkSplit = currentlink.split('&');
            var actualPageNo = 0;
            if (currentLinkSplit.length == 1) {
                actualPageNo = 1;
            }
            else {
                actualPageNo = currentLinkSplit[1].split('=')[1];
            }

            //console.log(actualPageNo);
            document.getElementById("CurrentIdPage").value = actualPageNo;

             var MaxPages =@consult_service.GetNumberOfPagesForMyResultsById(UsId);

            if (MaxPages > 1) {
                document.getElementById("...1").style.display = "none";

                if (MaxPages <= 4) {
                    document.getElementById("...2").style.display = "none";
                    document.getElementById("No_Page_>>").style.display = "none";
                    document.getElementById("No_Page_<<").style.display = "none";
                }
                else {
                    for (var i = 4; i <= MaxPages; i++)
                        document.getElementById("No_Page_" + i).style.display = "none";
                }

                if (MaxPages > 4) {
                    if (parseInt(actualPageNo) >= 3) {
                        document.getElementById("...1").style.display = "inline";
                    }

                    else {
                        document.getElementById("...1").style.display = "none";

                    }

                    if (parseInt(actualPageNo) >= MaxPages - 1) {
                        document.getElementById("...2").style.display = "none";

                    }
                    else {
                        document.getElementById("...2").style.display = "inline";
                    }



                    if (actualPageNo != 1 && actualPageNo != MaxPages) {
                        for (var i = 1; i <= MaxPages; i++) {
                            var id_string = "No_Page_".concat(i);
                            document.getElementById(id_string).style.display = "none";
                        }

                        for (var i = parseInt(actualPageNo) - 1; i <= parseInt(actualPageNo) + 1; i++) {
                            var id_string = "No_Page_".concat(i);
                            document.getElementById(id_string).style.display = "inline";
                        }
                    }
                    else {
                        if (actualPageNo == MaxPages) {
                            for (var i = 1; i <= MaxPages; i++) {

                                var id_string = "No_Page_".concat(i);
                                document.getElementById(id_string).style.display = "none";
                            }

                            for (var i = MaxPages - 2; i <= MaxPages; i++) {
                                var id_string = "No_Page_".concat(i);
                                document.getElementById(id_string).style.display = "inline";
                            }

                        }
                    }
                }
            }

            $('[id*=No_Page_]').click(function () {

                //var PgId = $('[id=Id]').val();
                var pageNumber = this.id.substring(8);
                //console.log(pageNumber)
                if (pageNumber == "<<") {
                    pageNumber = 1;

                    for (var i = 1; i <= MaxPages; i++) {
                        var id_string = "No_Page_".concat(i);
                        document.getElementById(id_string).style.display = "none";
                    }

                    for (var i = 1; i <= 3; i++) {
                        var id_string = "No_Page_".concat(i);
                        document.getElementById(id_string).style.display = "inline";
                    }

                }

                if (pageNumber == ">>") {
                    pageNumber = MaxPages;
                    for (var i = 1; i <= pageNumber; i++) {
                        var id_string = "No_Page_".concat(i);
                        document.getElementById(id_string).style.display = "none";
                    }

                    for (var i = pageNumber - 2; i <= pageNumber; i++) {
                        var id_string = "No_Page_".concat(i);
                        document.getElementById(id_string).style.display = "inline";
                    }
                }

                if (pageNumber == "<") {
                    pageNumber = parseInt($('#CurrentIdPage').val().valueOf());
                    pageNumber = pageNumber - 1;
                    if (pageNumber < 1) {
                        pageNumber = 1;

                    }
                }
                if (pageNumber == ">") {
                    pageNumber = parseInt($('#CurrentIdPage').val());
                    pageNumber = pageNumber + 1;
                    if (pageNumber > MaxPages) {
                        pageNumber = MaxPages;

                    }
                }

                var currentlink = window.location.href;
                var spl = currentlink.split("/");
                //alert(spl[2])
                var RedirectPage = 'https://'+spl[2]+'@Url.Action("MyResultsPaginated", "Consults")' + '?id='+'@ViewData["Id"]'+'&NoPage=' + pageNumber
                //console.log(RedirectPage)

                document.getElementById("CurrentIdPage").value = pageNumber;
                $.ajax({
                    /*type: 'POST',
                    url: 'Users',
                    data: { noPage: pageNumber },
                    success: function (data) {
                        console.log("Should redirect");
                        console.log(pageNumber)
                    }*/
                }).done(function (data) {
                    //console.log("done")
                    location.replace(RedirectPage);
                });
            });
        });

    </script>

